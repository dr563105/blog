<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Setting up AWS EC2 instance for ML | Deepak Ramani</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Setting up AWS EC2 instance for ML" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A guide to setup an AWS EC2 GPU instance for Machine learning tasks." />
<meta property="og:description" content="A guide to setup an AWS EC2 GPU instance for Machine learning tasks." />
<link rel="canonical" href="https://dr563105.github.io/blog/aws-setup/" />
<meta property="og:url" content="https://dr563105.github.io/blog/aws-setup/" />
<meta property="og:site_name" content="Deepak Ramani" />
<meta property="og:image" content="https://dr563105.github.io/blog/images/aws-logo.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-17T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://dr563105.github.io/blog/aws-setup/","@type":"BlogPosting","headline":"Setting up AWS EC2 instance for ML","dateModified":"2021-09-17T00:00:00-05:00","datePublished":"2021-09-17T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://dr563105.github.io/blog/aws-setup/"},"image":"https://dr563105.github.io/blog/images/aws-logo.png","description":"A guide to setup an AWS EC2 GPU instance for Machine learning tasks.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://dr563105.github.io/blog/feed.xml" title="Deepak Ramani" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-207674206-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-207674206-1');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

    <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Deepak Ramani</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.16,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger">
            <a class="page-link" href="https://github.com/dr563105/blog"><svg class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a><a class="page-link" href="/blog/about-me/">About Deepak</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
        </nav></div>
  </header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Setting up AWS EC2 instance for ML</h1><p class="page-description">A guide to setup an AWS EC2 GPU instance for Machine learning tasks.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-09-17T00:00:00-05:00" itemprop="datePublished">
        Sep 17, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      8 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#aws">aws</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#ubuntu">ubuntu</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#conda">conda</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#fastai">fastai</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#pytorch">pytorch</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Practical Deep Learning for Coders">Practical Deep Learning for Coders</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#markdown">markdown</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#fastai">Fast.ai</a></li>
<li class="toc-entry toc-h2"><a href="#aws-ec2">AWS EC2</a>
<ul>
<li class="toc-entry toc-h3"><a href="#requesting-service-limit-increase">Requesting service limit increase</a></li>
<li class="toc-entry toc-h3"><a href="#import-key-pair-to-aws-ec2-region">Import key pair to AWS EC2 region</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#launch-instance">Launch instance</a></li>
<li class="toc-entry toc-h2"><a href="#connect-to-instance">Connect to instance</a></li>
<li class="toc-entry toc-h2"><a href="#setup-ubuntu-server">Setup Ubuntu server</a></li>
<li class="toc-entry toc-h2"><a href="#setup-conda">Setup Conda</a></li>
<li class="toc-entry toc-h2"><a href="#install-nvidia">Install Nvidia</a></li>
<li class="toc-entry toc-h2"><a href="#create-conda-environment">Create conda environment</a></li>
<li class="toc-entry toc-h2"><a href="#install-fastbook-with-all-its-dependencies-including-cuda-enabled-pytorch-libraries">Install fastbook with all its dependencies including CUDA enabled pytorch libraries</a></li>
<li class="toc-entry toc-h2"><a href="#sanity-checks">Sanity checks:</a></li>
<li class="toc-entry toc-h2"><a href="#run-jupyter-notebook">Run jupyter notebook</a></li>
<li class="toc-entry toc-h2"><a href="#optional-email-setup">(Optional) Email Setup:</a></li>
<li class="toc-entry toc-h2"><a href="#stopping-the-instance">Stopping the instance</a></li>
<li class="toc-entry toc-h2"><a href="#wrapping-up">Wrapping up</a></li>
</ul><p>Amazon Web Services(AWS) offer great many services to suit user needs. For ML/DL all one
needs is a computer with access to a Graphical Processing Unit(GPU). Since AWS offers a
virtual PC with GPU at a reasonable price, we will use their service. This blog post will
use an AWS EC2 instance to make it ready for running ML tasks.</p>

<p><strong>Pre-requisites</strong>: This guide expects you to be familiar with linux(Ubuntu) environment and activated your AWS account.</p>

<h2 id="fastai">
<a class="anchor" href="#fastai" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fast.ai</h2>
<p>We will use Fastai library to make our ML models. <a href="https://www.fast.ai/about/">Fastai</a> is a open source software library for deep learning.
Developing ML models using fastai makes it much easier than just <a href="https://pytorch.org/features/">Pytorch</a>.</p>

<blockquote>
  <p><strong>Note</strong>:
This post is similar to the <a href="https://course.fast.ai/start_aws">fastai’s guide for AWS setup</a>
but with added commentary and updated final instructions.</p>
</blockquote>

<h2 id="aws-ec2">
<a class="anchor" href="#aws-ec2" aria-hidden="true"><span class="octicon octicon-link"></span></a>AWS EC2</h2>

<p>AWS EC2 is a service that provides a server PC for our use. It comes with a template
called amazon machine image(<a href="https://aws.amazon.com/machine-learning/amis/">AMI</a>) that makes it so easy to launch a virtual cloud server in less than two minutes.</p>

<p>For our ML purpose, we will use <code class="language-plaintext highlighter-rouge">g4dn.xlarge</code> EC2 on-demand instance. This particular instance has a 16GB Nvidia
T4 GPU. For more info on instances, check out <a href="https://aws.amazon.com/ec2/instance-types/">this</a> page at AWS.</p>

<blockquote>
  <p><strong>Note</strong>: Servers in regions(also known as availability zones(AZ)) such as North Virginia(N. Virginia), Ohio offer the chepeast
prices for <code class="language-plaintext highlighter-rouge">g4dn</code> instances starting at $0.526 per hour. Check out the pricing <a href="https://aws.amazon.com/ec2/pricing/on-demand/">here</a>.</p>
</blockquote>

<h3 id="requesting-service-limit-increase">
<a class="anchor" href="#requesting-service-limit-increase" aria-hidden="true"><span class="octicon octicon-link"></span></a>Requesting service limit increase</h3>

<p>To avoid misuse of GPU, amazon restricts its usage. However, we can request for service
limit increase with a support ticket. It is important to remember, service limit needs to be increased for each region.
The number of vCPUs an instance has, is a good measure of its capacity. In this case,
request <strong>16vCPUs</strong>(upto <code class="language-plaintext highlighter-rouge">g4dn.4xlarge</code>) in the support ticket.
Follow <a href="https://course.fast.ai/start_aws#step-2-request-service-limit">this</a> step to get access to a GPU.</p>

<blockquote>
  <p><strong>Tip</strong>: Usually a description of <em>‘to use for ML/DL course and training models’</em> would be an
acceptable reason for approval.</p>
</blockquote>

<h3 id="import-key-pair-to-aws-ec2-region">
<a class="anchor" href="#import-key-pair-to-aws-ec2-region" aria-hidden="true"><span class="octicon octicon-link"></span></a>Import key pair to AWS EC2 region</h3>

<p>Use <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#how-to-generate-your-own-key-and-import-it-to-aws">this amazon guide</a>
to import generate and import rsa key pair to an AWS EC2 region or AZ. It is important to store the private key in a secure directory.</p>

<h2 id="launch-instance">
<a class="anchor" href="#launch-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Launch instance</h2>

<p>Use <a href="https://course.fast.ai/start_aws#step-4-launch-an-instance">this fastai</a> step to launch an
<code class="language-plaintext highlighter-rouge">g4dn.xlarge</code> instance.</p>

<h2 id="connect-to-instance">
<a class="anchor" href="#connect-to-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Connect to instance</h2>

<p>Using the public IP of the instance and rsa private key we can login into our instance.</p>

<p>Login using</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-i</span> &lt;path-to-pem-file&gt; ubuntu@&lt;ip-address&gt;
</code></pre></div></div>
<p>The username is <em>ubuntu</em> for ubuntu EC2 instance, <em>ec2-user</em> for amazon AMI, and so on. We will be using <strong>ubuntu ec2 g4dn instance</strong>.</p>

<p>Example:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-i</span> ~/.ssh/myprivatekey.pem ubuntu@&lt;ip&gt;
</code></pre></div></div>

<p>You may be prompted about trusting this address, to which you should reply ‘yes’.</p>

<p><strong>Solution to possible shell environment problems</strong>: In some cases if the host terminal is using a different XTERM environment such as <code class="language-plaintext highlighter-rouge">xterm-kitty</code>(echo $TERM), that environment is reflected
in the remote EC2 instance. If that is the case, it best to use this command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">TERM</span><span class="o">=</span><span class="s1">'xterm-256color'</span> ssh <span class="nt">-i</span> &lt;path-to-pem-file&gt; ubuntu@&lt;ip-address&gt;
</code></pre></div></div>

<p>Also a possibility would be to add the TERM env to bashrc file.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'export TERM=xterm-256color'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">source</span> ~/.bashrc
</code></pre></div></div>

<blockquote>
  <p><strong>Why the need to do to set the TERM env?</strong> Because, remote host will have the basic env set
and the keystrokes such as previously run command(up arrow) would return a scrambled output
on the screen.</p>
</blockquote>

<h2 id="setup-ubuntu-server">
<a class="anchor" href="#setup-ubuntu-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup Ubuntu server</h2>

<p>First, to do basic ubuntu configurations, such as updating packages, and turning on auto-updates, execute:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nt">-y</span> <span class="nb">install </span>git
git clone https://github.com/dr563105/fastsetup.git
<span class="nb">cd </span>fastsetup
<span class="nb">sudo</span> ./ubuntu-initial.sh
</code></pre></div></div>

<p>The setup shell script will create a new user inside the cloud server, installs/updates the necessary packages and libraries, installs firewalls, and sets up ssh.</p>
<blockquote>
  <p><strong>Note</strong>: This new user creation is not to be confused with IAM user created by AWS root user.</p>
</blockquote>

<p>Reboot when prompted. Wait a couple of minutes for reboot, then <code class="language-plaintext highlighter-rouge">ssh</code> back in.</p>

<p>To reconnect using ssh, add an additional -L flag which will allow you to open up ports to connect to Jupyter Notebook once it’s installed:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-i</span> &lt;path-to-pem-file&gt; <span class="nt">-L</span> localhost:8888:localhost:8888 ubuntu@&lt;ip-address&gt;
</code></pre></div></div>

<p><strong>(Optional): Change default shell to ZSH with <a href="https://github.com/ohmyzsh/ohmyzsh">Oh My ZSH</a></strong>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span class="si">)</span><span class="s2">"</span> <span class="s2">""</span> <span class="nt">--unattended</span>
</code></pre></div></div>
<p>Change default SHELL to ZSH using</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>chsh <span class="nv">$USER</span> <span class="nt">-s</span> /bin/zsh
</code></pre></div></div>

<p>When prompted for password, use the password entered at the user creation step during the setup
process.</p>

<p>Logout and login again to activate ZSH shell. It is possible to switch without
disconnecting but I find this step simpler to other solutions.</p>

<h2 id="setup-conda">
<a class="anchor" href="#setup-conda" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup Conda</h2>

<p><a href="https://docs.conda.io/projects/conda/en/latest/">Conda</a> is an open source package management system to setup environments irrespective of
the OS. One of the major advantages of conda is that it easily installs all the
dependencies for a package. Anaconda provides a conda installer with thousands of
packages. However, for our case, we will use <a href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a>, a minimal installer of conda.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>fastsetup
./setup-conda.sh
</code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>:
Deviates from fastai’s fastsetup <code class="language-plaintext highlighter-rouge">setup-conda.sh</code>script in creating a <code class="language-plaintext highlighter-rouge">.condarc</code> file.
My experiments have shown this file to be troublesome.</p>
</blockquote>

<p>If you’ve worked with conda installs before, you’ll know that it is too slow.
<a href="https://github.com/mamba-org/mamba">Mamba</a> is a reimplementation of the conda package
manager in C++. So we install that next.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">source</span> ~/.bashrc <span class="o">(</span>or <span class="nb">source</span> ~/.zshrc<span class="o">)</span>
conda <span class="nb">install </span>mamba <span class="nt">-n</span> base <span class="nt">-c</span> fastchan
</code></pre></div></div>

<p>We use <code class="language-plaintext highlighter-rouge">fastchan</code> as the channel source. <code class="language-plaintext highlighter-rouge">fastchan</code> is an anaconda pacakage
from fastai team. A detailed post on fastchan from <a href="https://wandb.ai/wandb_fc/pytorch-image-models/reports/A-faster-way-to-get-working-and-up-to-date-conda-environments-using-fastchan---Vmlldzo2ODIzNzA">weights and biases</a>.</p>

<blockquote>
  <p>Don’t mix <code class="language-plaintext highlighter-rouge">conda-forge</code> with <code class="language-plaintext highlighter-rouge">fastai</code> channels. Stick to either <code class="language-plaintext highlighter-rouge">fastchan</code> or
<code class="language-plaintext highlighter-rouge">anaconda</code>.</p>
</blockquote>

<h2 id="install-nvidia">
<a class="anchor" href="#install-nvidia" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Nvidia</h2>

<p>It is much faster to train ML models in a GPU. Currently only Nvidia GPUs are supported.
Since our instance has a GPU, we need to install its drivers and activate it.</p>

<p>Use this command to list available drivers: <code class="language-plaintext highlighter-rouge">ubuntu-drivers devices</code></p>

<blockquote>
  <p><strong>Tip</strong>: Choose the “recommended” option, plus the <code class="language-plaintext highlighter-rouge">-server</code> suffix.</p>
</blockquote>

<p>When you install “470” might be a different number, based on <code class="language-plaintext highlighter-rouge">ubuntu-drivers</code> output above</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-fast <span class="nb">install</span> <span class="nt">-y</span> nvidia-driver-470-server
<span class="nb">sudo </span>modprobe nvidia
nvidia-smi
</code></pre></div></div>

<p>When prompted for a password, enter the password you entered while you ran the ubuntu
setup script.</p>

<blockquote>
  <p><strong>Note</strong>:
The command installs <code class="language-plaintext highlighter-rouge">cuda 11.4</code>. This is not to be confused with <code class="language-plaintext highlighter-rouge">cudatoolkit=11.1</code> which
is needed for <code class="language-plaintext highlighter-rouge">pytorch=1.9</code>. Also each pytorch conda install comes with its own <code class="language-plaintext highlighter-rouge">cuDNN</code>
runtime. So installing <code class="language-plaintext highlighter-rouge">cuDNN</code> separately is not needed. <code class="language-plaintext highlighter-rouge">cuda 11.4</code> comes to play if
pytorch is built from source.</p>
</blockquote>

<h2 id="create-conda-environment">
<a class="anchor" href="#create-conda-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create conda environment</h2>

<p>It is good practice to install the necessary packages in a new conda
environment. Installing everything in the conda <code class="language-plaintext highlighter-rouge">base</code> environment is not advisable.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda create <span class="nt">-n</span> &lt;envname&gt; <span class="nt">-y</span>
conda create <span class="nt">-n</span> mlenv <span class="nt">-y</span>
conda activate mlenv
</code></pre></div></div>

<h2 id="install-fastbook-with-all-its-dependencies-including-cuda-enabled-pytorch-libraries">
<a class="anchor" href="#install-fastbook-with-all-its-dependencies-including-cuda-enabled-pytorch-libraries" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install fastbook with all its dependencies including CUDA enabled pytorch libraries</h2>

<p>Now you’re ready to install all needed packages for the fast.ai course:
Make there is enough space to install(<code class="language-plaintext highlighter-rouge">df -h</code>). You need about 15GB of space.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mamba <span class="nb">install </span>fastbook <span class="nv">python</span><span class="o">=</span>3.8 <span class="nt">-c</span> fastai <span class="nt">-c</span> fastchan <span class="nt">-y</span>
conda <span class="nb">install </span>pytorch torchaudio torchvision <span class="nv">python</span><span class="o">=</span>3.8 <span class="nv">cudatoolkit</span><span class="o">=</span>11.1 <span class="nt">-c</span> fastchan <span class="nt">-y</span>
</code></pre></div></div>

<p>Fastbook is a fastai’s book on using fastai for ML development. As a python package, it installs all the dependent packages.
To see what it install remove <code class="language-plaintext highlighter-rouge">-y</code> from the command.</p>

<p>Usually one command(<code class="language-plaintext highlighter-rouge">mamba install fastbook</code>) was enough previously to install everything.
However, there seems to be package conflicts when executed now. Hence, the additional
conda install step which upgrades pytorch, torchvision to the latest GPU version.</p>

<blockquote>
  <p><strong>Tip</strong>: For dry run, use ‘-d’ argument in the mamba install command.</p>
</blockquote>

<blockquote>
  <p><strong>Note</strong>: Installing fastbook doesn’t mean you must use fastai. It just installs
everything needed for ML tasks. If you’ve noticed carefully while installing, it is
Pytorch, Cuda packages that require huge memory space. Other packages come just under 2 GB.</p>
</blockquote>

<h2 id="sanity-checks">
<a class="anchor" href="#sanity-checks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sanity checks:</h2>
<p>These checks are to verifying if indeed CUDA enabled pytorch is installed correctly. Enter
these commands inside a python shell.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$which</span> python
/home/ubuntu/miniconda3/envs/mlenv/bin/python
<span class="nv">$python</span> <span class="nt">--version</span>
Python 3.8.5
<span class="nv">$python</span>
<span class="o">&gt;&gt;&gt;</span>import torch
<span class="o">&gt;&gt;&gt;</span>torch.version.cuda
<span class="s1">'11.1'</span>
<span class="o">&gt;&gt;&gt;</span>torch.cuda.is_available<span class="o">()</span>
True
<span class="o">&gt;&gt;&gt;</span> torch.cuda.device_count<span class="o">()</span>
1
<span class="o">&gt;&gt;&gt;</span>torch.cuda.current_device<span class="o">()</span>
0
<span class="o">&gt;&gt;&gt;</span>torch.cuda.get_device_name<span class="o">(</span>0<span class="o">)</span>
<span class="s1">'Tesla T4'</span>
</code></pre></div></div>

<p>If the commands return the same results, then we’re ready for ML development.</p>

<h2 id="run-jupyter-notebook">
<a class="anchor" href="#run-jupyter-notebook" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run jupyter notebook</h2>
<p>To download the notebooks, run:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd
</span>git clone https://github.com/fastai/fastbook
<span class="nb">cd </span>fastbook
jupyter notebook
</code></pre></div></div>

<p>Click on the localhost url that is displayed. It will open iPython notebook in your
default browser. Alternatively, that link can be copied and opened in any browser of
choice.</p>

<p>There are other Jupyter notebook guides that require to add a password for access. So far
I’ve not needed those steps for my tasks.</p>

<h2 id="optional-email-setup">
<a class="anchor" href="#optional-email-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>(Optional) Email Setup:</h2>

<p>To set up email:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> ./opensmtpd-install.sh
</code></pre></div></div>

<p>To test email, create a text file <code class="language-plaintext highlighter-rouge">msg</code> containing a message to send, then send it with:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>msg |  mail <span class="nt">-r</span> <span class="s2">"x@</span><span class="si">$(</span><span class="nb">hostname</span> <span class="nt">-d</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-s</span> <span class="s1">'subject'</span> EMAIL_ADDR
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">EMAIL_ADDR</code> with an address to send to. You can get a useful testing address from <a href="https://www.mail-tester.com/">mail-tester</a>.</p>

<h2 id="stopping-the-instance">
<a class="anchor" href="#stopping-the-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stopping the instance</h2>

<p>After you have finished your work, unless a training is going on, it is critical to stop
the instance, if you wish to save your AWS bill.</p>

<p>Use either <em>EC2</em> dashboard to <strong>stop</strong> the instance(instance-&gt;actions-&gt;instance
state-&gt;stop) or use this command in the terminal</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>shutdown <span class="nt">-h</span> now
</code></pre></div></div>
<blockquote>
  <p><strong>Note</strong>: Pressing <strong>terminate</strong> will remove the instance completely and your work will be lost forever.</p>
</blockquote>

<h2 id="wrapping-up">
<a class="anchor" href="#wrapping-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wrapping up</h2>
<p>There it is: an instance that is ready for ML development. If you have questions or
feedback, reach me through the comments or via twitter.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="dr563105/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/aws-setup/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A Data Science Blog</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/dr563105" title="dr563105"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://stackoverflow.com/users/13539744" title="13539744"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#stackoverflow"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/deepakr05" title="deepakr05"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/thosegradients" title="thosegradients"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
